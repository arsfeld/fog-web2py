(dp1
S'output'
p2
S''
sS'layer'
p3
S'/home/arosenfeld/Dropbox/fog_backup/web2py/applications/kpax/controllers/members.py'
p4
sS'code'
p5
S'# coding: utf8\nimport ldap\n\nfog_dn = \'dc=fog,dc=icmc,dc=usp,dc=br\'\n\ndef _ldap_connection():\n    return ldap.initialize(\'ldap://fog.icmc.usp.br\')\n\ndef _in_directory(username):\n    con = _ldap_connection()\n    users_list = con.search_s(\'ou=people,\' + fog_dn, ldap.SCOPE_SUBTREE, \'(uid=%s)\' % username)\n    con.unbind()\n    return T(str(len(users_list) > 0))\n    \ndef sync_db():\n    con = _ldap_connection()\n    con.simple_bind_s(\'cn=admin,\' + fog_dn, \'f0gs3rv3r\')\n    ldap_users = con.search_s(\'ou=people,\' + fog_dn, ldap.SCOPE_SUBTREE, \'(objectClass=posixAccount)\', \n        attrlist=[\'uid\', \'uidNumber\', \'cn\', \'sn\', \'userPassword\'])\n    ldap_names = {}\n    for ldap_dn, ldap_attrs in ldap_users:\n        #print ldap_attrs\n        ldap_attrs[\'dn\'] = [ldap_dn]\n        #print ldap_attrs\n        ldap_names[ldap_attrs[\'uid\'][0]] = ldap_attrs\n    names_to_add = []\n    names_in_db = {}\n    users = []\n    for user in db(db.user.id>0).select():\n        users.append(user.username)\n        if user.username not in ldap_names:\n            names_to_add.append(user.username)\n            uid_list = con.search_s(\'ou=people,\' + fog_dn, ldap.SCOPE_SUBTREE, \'(objectClass=posixAccount)\', attrlist=[\'uidNumber\'])\n            uid = max([int(user_attrs.get(\'uidNumber\', [1000])[0]) for user_dn, user_attrs in uid_list]) + 1\n            con.add_s(\'uid=%s,ou=people,%s\' %  (user.username, fog_dn),\n                [(\'uid\', user.username),\n                 (\'objectClass\', [\'posixAccount\', \'inetOrgPerson\']),\n                 (\'cn\', user.firstname),\n                 (\'sn\', user.lastname), \n                 (\'uidNumber\', str(uid)),\n                 (\'gidNumber\', \'1000\'), \n                 (\'homeDirectory\', \'\')])  \n        else:\n            attrs = []\n            missing = []\n            equal = []\n            mod_list = []\n            for ldap_attr, db_attr in [(\'cn\', \'firstname\'), \n                                       (\'sn\', \'lastname\'),\n                                       (\'userPassword\', \'password\')]:\n                if ldap_attr not in ldap_names[user.username]:\n                    missing.append(ldap_attr)\n                    op_type = ldap.MOD_ADD\n                elif ldap_names[user.username][ldap_attr][0] != getattr(user, db_attr):\n                    attrs.append((db_attr, str(ldap_names[user.username][ldap_attr]), getattr(user, db_attr)))\n                    op_type = ldap.MOD_REPLACE\n                else:\n                    equal.append(ldap_attr)\n                    op_type = False\n                if op_type:\n                    mod_list.append((op_type, ldap_attr, str(getattr(user, db_attr))))\n            if mod_list:\n                print mod_list\n                con.modify_s(ldap_names[user.username][\'dn\'], mod_list)\n            names_in_db[user.username] = {\'different\': attrs,\n                                          \'missing\': missing,\n                                          \'equal\': equal}\n    extra_users = [uid for uid in ldap_names if uid not in users]\n    for user in extra_users:\n        con.delete_s(ldap_names[user][\'dn\'][0])\n    con.unbind()\n    return dict(names_to_add=names_to_add, names_in_db=names_in_db, extra_users=extra_users)\n\ndef add():\n    form=FORM(TABLE(\n          TR(T("First name:"), INPUT(_name="firstname",requires=IS_NOT_EMPTY())),\n          TR(T("Last name:"), INPUT(_name="lastname",requires=IS_NOT_EMPTY())),\n          TR(T("Username:"), INPUT(_name="username", requires=IS_NOT_EMPTY())),\n          TR(T("Email:"), INPUT(_name="email",requires=[IS_NOT_EMPTY(), IS_NOT_IN_DB(db,\'user.email\')])),\n          TR("Password:", INPUT(_name="password",_type=\'password\',requires=[IS_NOT_EMPTY(),CRYPT()])),\\\n                    TR("Password (again):",\\\n          INPUT(_name="password2",_type=\'password\',requires=[IS_NOT_EMPTY(),CRYPT()])),\\\n                    TR("",INPUT(_type="submit",_value="register"))))\n    if form.accepts(request.vars,session) and \\\n       form.vars.password==form.vars.password2:\n        if EMAIL_VERIFICATION:\n            key=md5.new(str(random.randint(0,9999))).hexdigest()\n        else:\n            key=\'\'\n        id=db.user.insert(firstname=form.vars.firstname,\n                          lastname=form.vars.lastname,\n                          username=form.vars.username,\n                          email=form.vars.email,\n                          password=form.vars.password,\n                          verification=key)\n                          \n        response.flash=\'Registration completed, you may login now\'\n        redirect(URL(r=request,f=\'list\'))\n    else:\n        return dict(form=form)\n\ndef index(): \n    table = TABLE(*([TR(TD("Username"), TD("First name"), TD("In LDAP"))] + \n                    [TR(TD(member.username), TD(member.firstname), \n                        TD(A("Check", \n                             _href="#", \n                             _onclick="ajax(\'" + URL(r=request,f=\'in_directory/\'+member.username) + "\',[\'%s_ldap\'],\'%s_ldap\');" % (member.username, member.username)), \n                             _id=member.username + \'_ldap\')) \\\n                        for member in db(db.user.id>0).select()]))\n    return dict(table=table)\n    \ndef in_directory():\n    username = request.args[0]\n    return _in_directory(username)\n\ndef list():\n    con = ldap.initialize(\'ldap://fog.icmc.usp.br\')\n    users_list = con.search_s(\'ou=people,\' + fog_dn, ldap.SCOPE_SUBTREE, \'(objectClass=posixAccount)\')\n    return dict(list=users_list)    \n\ndef register():\n    form=FORM(TABLE(\n          TR(T("First name:"), INPUT(_name="firstname",requires=IS_NOT_EMPTY())),\n          TR(T("Last name:"), INPUT(_name="lastname",requires=IS_NOT_EMPTY())),\n          TR(T("Username:"), INPUT(_name="username", requires=IS_NOT_EMPTY())),\n          TR(T("Email:"), INPUT(_name="email",requires=[IS_NOT_EMPTY(), IS_NOT_IN_DB(db,\'user.email\')])),\n          TR("Password:", INPUT(_name="password",_type=\'password\',requires=[IS_NOT_EMPTY(),CRYPT()])),\\\n                    TR("Password (again):",\\\n          INPUT(_name="password2",_type=\'password\',requires=[IS_NOT_EMPTY(),CRYPT()])),\\\n                    TR("",INPUT(_type="submit",_value="register"))))\n    if form.accepts(request.vars,session) and \\\n       form.vars.password==form.vars.password2:\n        con = ldap.initialize(\'ldap://fog.icmc.usp.br\')\n        con.simple_bind_s(\'cn=admin,\' + fog_dn, \'f0gs3rv3r\')\n        uid_list = con.search_s(\'ou=people,\' + fog_dn, ldap.SCOPE_SUBTREE, \'(objectClass=posixAccount)\', attrlist=[\'uidNumber\'])\n        uid = max([int(i[1].get(\'uidNumber\', [1000])[0]) for i in uid_list]) + 1\n        con.add_s(\'uid=%s,ou=people,\' % form.vars.username + fog_dn, \n            [(\'uid\', form.vars.username),\n             (\'objectClass\', [\'posixAccount\', \'inetOrgPerson\']),\n             (\'cn\', form.vars.firstname),\n             (\'sn\', form.vars.lastname), \n             (\'uidNumber\', str(uid)),\n             (\'gidNumber\', \'1000\'), \n             (\'homeDirectory\', \'\')])\n        con.unbind()\n        response.flash = "User registered"\n    return dict(form=form)\n\nresponse._vars=response._caller(sync_db)\n'
p6
sS'traceback'
p7
S'Traceback (most recent call last):\n  File "/home/arosenfeld/Dropbox/fog_backup/web2py/gluon/restricted.py", line 184, in restricted\n    exec ccode in environment\n  File "/home/arosenfeld/Dropbox/fog_backup/web2py/applications/kpax/controllers/members.py", line 149, in <module>\n  File "/home/arosenfeld/Dropbox/fog_backup/web2py/gluon/globals.py", line 103, in <lambda>\n    self._caller = lambda f: f()\n  File "/home/arosenfeld/Dropbox/fog_backup/web2py/applications/kpax/controllers/members.py", line 64, in sync_db\n    con.modify_s(ldap_names[user.username][\'dn\'], mod_list)\n  File "/usr/lib/python2.6/site-packages/ldap/ldapobject.py", line 327, in modify_s\n    msgid = self.modify(dn,modlist)\n  File "/usr/lib/python2.6/site-packages/ldap/ldapobject.py", line 324, in modify\n    return self.modify_ext(dn,modlist,None,None)\n  File "/usr/lib/python2.6/site-packages/ldap/ldapobject.py", line 297, in modify_ext\n    return self._ldap_call(self._l.modify_ext,dn,modlist,EncodeControlTuples(serverctrls),EncodeControlTuples(clientctrls))\n  File "/usr/lib/python2.6/site-packages/ldap/ldapobject.py", line 96, in _ldap_call\n    result = func(*args,**kwargs)\nTypeError: argument 1 must be string, not list\n'
p8
s.